name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  pull_request:
    branches: [ main ]

# Default environment variables
env:
  BUILD_DIR: build
  TARGET_BRANCH: gh-pages

# Set the required permissions for the workflow
permissions:
  contents: write  # For pushing to gh-pages branch
  pages: write     # For GitHub Pages
  id-token: write  # For GitHub OIDC
  deployments: write  # For deployment status
  actions: write   # For GitHub Actions API
  checks: write    # For status checks
  statuses: write  # For commit statuses
  pull-requests: write  # For pull request comments
  security-events: write  # For security events
  issues: write    # For issues
  # metadata: read is not a valid permission, removed

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build and Prepare for Deployment
        run: |
          # Create a clean build directory
          echo "Setting up build environment..."
          rm -rf $BUILD_DIR
          mkdir -p $BUILD_DIR
          
          # Copy only necessary files
          echo "Copying project files..."
          cp -r * .[^.]* $BUILD_DIR/ 2>/dev/null || :
          
          # Move into build directory
          cd $BUILD_DIR
          
          # Install dependencies if package.json exists
          if [ -f "package.json" ]; then
            echo "Installing dependencies..."
            npm ci --production=false
            
            # Run build script if it exists
            if grep -q "build" package.json; then
              echo "Running build script..."
              npm run build
            fi
            
            # Clean up node_modules to reduce size
            rm -rf node_modules
          fi
          
          # Create a basic index.html if one doesn't exist
          if [ ! -f "index.html" ] && [ ! -f "public/index.html" ]; then
            echo "Creating default index.html..."
            mkdir -p public
            cat > public/index.html << 'EOL'
            <!DOCTYPE html>
            <html>
            <head>
              <title>Donald W. Smith Jr. Portfolio</title>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body { 
                  font-family: Arial, sans-serif; 
                  line-height: 1.6; 
                  max-width: 800px; 
                  margin: 0 auto; 
                  padding: 20px;
                }
                h1 { color: #2c3e50; }
                .deploy-info {
                  margin-top: 2em;
                  padding: 1em;
                  background: #f8f9fa;
                  border-radius: 4px;
                  font-size: 0.9em;
                  color: #6c757d;
                }
              </style>
            </head>
            <body>
              <h1>Welcome to My Portfolio</h1>
              <p>This is the default landing page for your GitHub Pages site.</p>
              
              <div class="deploy-info">
                <p><strong>Deployment Information:</strong></p>
                <ul>
                  <li>Last updated: <span id="timestamp">$(date)</span></li>
                  <li>Commit: <code>$GITHUB_SHA</code></li>
                  <li>Branch: <code>main</code></li>
                </ul>
              </div>
              
              <script>
                // Update timestamp with client-side time
                document.getElementById('timestamp').textContent = new Date().toLocaleString();
              </script>
            </body>
            </html>
            EOL
          fi
          
          # Ensure all built files are in the root
          if [ -d "public" ]; then
            echo "Moving public files to root..."
            mv public/* .
            rm -rf public
          fi
          
          # Create a .nojekyll file to bypass Jekyll processing
          touch .nojekyll
          
          echo "Build complete!"
          echo "Contents of build directory:"
          ls -la
          
          # Verify index.html exists
          if [ ! -f "index.html" ]; then
            echo "ERROR: index.html was not generated!"
            ls -la
            exit 1
          fi
      
      - name: Deploy to gh-pages branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Move to the build directory
          cd $BUILD_DIR
          
          # Initialize git in the build directory
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Add remote with authentication
          git remote add origin "https://x-access-token:$GH_TOKEN@github.com/$GITHUB_REPOSITORY.git"
          
          # Fetch the gh-pages branch if it exists
          if git ls-remote --exit-code --heads origin $TARGET_BRANCH; then
            echo "$TARGET_BRANCH branch exists, checking out..."
            git fetch origin $TARGET_BRANCH
            git checkout $TARGET_BRANCH
            git rm -rf .
          else
            echo "$TARGET_BRANCH branch does not exist, creating new branch..."
            git checkout --orphan $TARGET_BRANCH
            git rm -rf .
          fi
          
          # Add and commit the built files
          git add .
          git commit -m "Deploy to GitHub Pages (from $GITHUB_SHA)"
          
          # Force push to the gh-pages branch
          git push -f origin $TARGET_BRANCH
          
          # Output the deployment URL
          echo "Deployment to $TARGET_BRANCH branch complete!"
          echo "View your site at: https://$GITHUB_REPOSITORY_OWNER.github.io/${GITHUB_REPOSITORY#*/}"
          
      - name: Get the deployed URL
        id: deployment
        run: |
          # Get the repository owner and name
          REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          echo "page_url=https://$GITHUB_REPOSITORY_OWNER.github.io/$REPO_NAME" >> $GITHUB_OUTPUT
          
      - name: Show deployment status
        run: |
          echo "Deployment to gh-pages branch complete!"
          echo "View your site at: ${{ steps.deployment.outputs.page_url }}"
          echo "Note: It may take a few minutes for the site to be available."
