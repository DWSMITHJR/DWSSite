name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  pull_request:
    branches: [ main ]

# Default environment variables
env:
  BUILD_DIR: build
  TARGET_BRANCH: gh-pages

permissions:
  contents: write
  pages: write
  id-token: write
  deployments: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: |
          # Set up build directory
          echo "Setting up build environment..."
          mkdir -p $BUILD_DIR
          
          # Copy all files to build directory
          echo "Copying files to build directory..."
          rsync -av --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude=$BUILD_DIR . $BUILD_DIR/
          
          cd $BUILD_DIR
          
          # Install dependencies if package.json exists
          if [ -f "package.json" ]; then
            echo "Installing dependencies..."
            npm ci --production=false
            
            # Run build script if it exists
            if grep -q "build" package.json; then
              echo "Running build script..."
              npm run build
            fi
          fi
          
          # Create a basic index.html if one doesn't exist
          if [ ! -f "index.html" ] && [ ! -f "public/index.html" ]; then
            echo "Creating default index.html..."
            mkdir -p public
            cat > public/index.html << 'EOL'
            <!DOCTYPE html>
            <html>
            <head>
              <title>Donald W. Smith Jr. Portfolio</title>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body { 
                  font-family: Arial, sans-serif; 
                  line-height: 1.6; 
                  max-width: 800px; 
                  margin: 0 auto; 
                  padding: 20px;
                }
                h1 { color: #2c3e50; }
              </style>
            </head>
            <body>
              <h1>Welcome to My Portfolio</h1>
              <p>Content is being served via GitHub Pages.</p>
              <p>Last updated: $(date)</p>
              <p>Commit: $GITHUB_SHA</p>
            </body>
            </html>
            EOL
          fi
          
          echo "Build complete!"
          echo "Contents of build directory:"
          ls -la
      
      - name: Deploy to gh-pages branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Move to the build directory
          cd $BUILD_DIR
          
          # Initialize git in the build directory
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Add remote with authentication
          git remote add origin "https://x-access-token:$GH_TOKEN@github.com/$GITHUB_REPOSITORY.git"
          
          # Create or reset the gh-pages branch
          git checkout --orphan $TARGET_BRANCH
          git rm -rf .
          
          # Add and commit the built files
          git add .
          git commit -m "Deploy to GitHub Pages (from $GITHUB_SHA)"
          
          # Force push to the gh-pages branch
          git push -f origin $TARGET_BRANCH
          
          # Set branch protection for gh-pages
          curl -X PUT \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/branches/$TARGET_BRANCH/protection" \
            -d '{"required_status_checks": null, "enforce_admins": null, "required_pull_request_reviews": null, "restrictions": null, "required_linear_history": false, "allow_force_pushes": true, "allow_deletions": true}'
          
      - name: Get the deployed URL
        id: deployment
        run: |
          # Get the repository owner and name
          REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          echo "page_url=https://$GITHUB_REPOSITORY_OWNER.github.io/$REPO_NAME" >> $GITHUB_OUTPUT
          
      - name: Show deployment status
        run: |
          echo "Deployment to gh-pages branch complete!"
          echo "View your site at: ${{ steps.deployment.outputs.page_url }}"
          echo "Note: It may take a few minutes for the site to be available."
