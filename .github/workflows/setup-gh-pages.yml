name: Setup GitHub Pages

on:
  workflow_dispatch:
    inputs:
      enable_github_pages:
        description: 'Enable GitHub Pages'
        required: true
        default: true
        type: boolean

# Set the required permissions at the workflow level
permissions:
  contents: write
  pages: write
  id-token: write
  deployments: write
  administration: write  # Required for repository settings

jobs:
  setup-gh-pages:
    runs-on: ubuntu-latest
    environment: github-pages
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup GitHub Pages
        if: github.event.inputs.enable_github_pages == 'true'
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { owner, repo } = context.repo;
            
            try {
              console.log('Attempting to enable GitHub Pages...');
              
              // First, ensure the gh-pages branch exists
              try {
                await github.rest.repos.getBranch({
                  owner,
                  repo,
                  branch: 'gh-pages'
                });
                console.log('gh-pages branch already exists');
              } catch (error) {
                console.log('Creating gh-pages branch...');
                // Get the SHA of the main branch
                const { data: mainBranch } = await github.rest.repos.getBranch({
                  owner,
                  repo,
                  branch: 'main'
                });
                
                // Create the gh-pages branch
                await github.rest.git.createRef({
                  owner,
                  repo,
                  ref: 'refs/heads/gh-pages',
                  sha: mainBranch.commit.sha
                });
                console.log('Created gh-pages branch');
              }
              
              // Enable GitHub Pages
              const response = await github.rest.repos.createPagesSite({
                owner,
                repo,
                source: {
                  branch: 'gh-pages',
                  path: '/'
                }
              });
              
              console.log('GitHub Pages enabled successfully!');
              console.log('Response:', JSON.stringify(response.data, null, 2));
              
              // Get the Pages settings to verify
              try {
                const pagesInfo = await github.rest.repos.getPages({
                  owner,
                  repo
                });
                console.log('GitHub Pages settings:', JSON.stringify(pagesInfo.data, null, 2));
                return 'GitHub Pages setup complete!';
              } catch (error) {
                console.warn('Could not verify Pages settings:', error);
                return 'GitHub Pages setup initiated but could not verify settings. Check repository settings.';
              }
            } catch (error) {
              console.error('Error setting up GitHub Pages:');
              if (error.response) {
                console.error('Status:', error.response.status);
                console.error('Data:', error.response.data);
                console.error('Headers:', error.response.headers);
              } else {
                console.error(error);
              }
              throw new Error('Failed to set up GitHub Pages. See logs for details.');
                console.error('Response data:', error.response.data);
                console.error('Response status:', error.response.status);
              }
              throw error;
            }

      - name: Show GitHub Pages URL
        if: github.event.inputs.enable_github_pages == 'true'
        run: |
          echo "GitHub Pages has been enabled!"
          echo "Your site will be available at:"
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo ""
          echo "Note: It may take a few minutes for the site to be available after the first deployment."
