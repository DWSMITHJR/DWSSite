<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Library - Donald W. Smith Jr.</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/documents.css">
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-particles" id="particles"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">
                <img src="images/DLogo.jpg" alt="Logo" class="logo-img">
            </a>
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="link.html">Request Code</a></li>
                    <li><a href="info.html" class="active">Documents</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- Login Form Section -->
        <section id="login-section" class="section">
            <h1 class="section-title fade-in">Document Library</h1>
            <div class="login-container fade-in">
                <h2>Please sign in to access documents</h2>
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" name="email" required 
                               placeholder="Enter your email address" class="form-input">
                        <div class="error-message" id="emailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="accessCode">Access Code</label>
                        <input type="text" id="accessCode" name="accessCode" required 
                               placeholder="Enter your 6-digit code" class="form-input" maxlength="6" pattern="\d{6}">
                        <div class="error-message" id="codeError"></div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Sign In</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Document List Section (initially hidden) -->
        <section id="documents-section" class="section" style="display: none;">
            <div class="documents-header">
                <h1 class="section-title">Document Library</h1>
                <button id="signOutBtn" class="btn btn-secondary">Sign Out</button>
            </div>
            <div class="documents-container">
                <table id="documentsTable" class="documents-table">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Size</th>
                            <th>Last Modified</th>
                        </tr>
                    </thead>
                    <tbody id="documentsList">
                        <!-- Documents will be inserted here by JavaScript -->
                    </tbody>
                </table>
                <div id="emptyState" class="empty-state">
                    No documents found in the files directory.
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="contact">
        <div class="footer-content">
            <div class="footer-social">
                <a href="https://linkedin.com/in/donaldwsmithjr" target="_blank" aria-label="LinkedIn">
                    <span>üîó</span>
                </a>
                <a href="https://github.com/DWSMITHJR" target="_blank" aria-label="GitHub">
                    <span>üêô</span>
                </a>
            </div><span>‚úâÔ∏è</span>
            <p class="footer-text">¬© 2025 <a href="mailto:architect@donaldwsmithjr.com" aria-label="Email">
            Donald W. Smith Jr.</a> All rights reserved.
            </p>
        </div>
    </footer>

    <script>
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already authenticated
            checkAuthStatus();
            
            // Initialize the login form
            initLoginForm();
            
            // Initialize sign out button
            const signOutBtn = document.getElementById('signOutBtn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', handleSignOut);
            }
            
            // Initialize particles if the function exists
            if (typeof createParticles === 'function') {
                createParticles();
            }
            
            // Add scroll animation
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });
            
            document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));
        });
        
        // Check if user is already authenticated
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/documents', { method: 'HEAD' });
                if (response.ok) {
                    // User is authenticated, show documents
                    showDocumentsSection();
                    loadDocuments();
                } else {
                    // Not authenticated, show login form
                    showLoginSection();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                showLoginSection();
            }
        }
        
        // Initialize login form
        function initLoginForm() {
            const form = document.getElementById('loginForm');
            const emailInput = document.getElementById('loginEmail');
            const codeInput = document.getElementById('accessCode');
            const emailError = document.getElementById('emailError');
            const codeError = document.getElementById('codeError');
            
            if (!form) return;
            
            // Validate email on input
            emailInput.addEventListener('input', () => {
                if (emailInput.validity.valid) {
                    emailError.textContent = '';
                } else {
                    showEmailError(emailInput, emailError);
                }
            });
            
            // Format access code input (only numbers, max 6 digits)
            codeInput.addEventListener('input', (e) => {
                // Only allow numbers
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                // Limit to 6 digits
                if (e.target.value.length > 6) {
                    e.target.value = e.target.value.slice(0, 6);
                }
                
                if (e.target.validity.valid) {
                    codeError.textContent = '';
                } else {
                    showCodeError(codeInput, codeError);
                }
            });
            
            // Handle form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = emailInput.value.trim();
                const code = codeInput.value.trim();
                
                // Validate inputs
                let isValid = true;
                
                if (!email) {
                    showEmailError(emailInput, emailError, 'Email is required');
                    isValid = false;
                } else if (!emailInput.validity.valid) {
                    showEmailError(emailInput, emailError);
                    isValid = false;
                }
                
                if (!code) {
                    showCodeError(codeInput, codeError, 'Access code is required');
                    isValid = false;
                } else if (code.length !== 6) {
                    showCodeError(codeInput, codeError, 'Code must be 6 digits');
                    isValid = false;
                }
                
                if (!isValid) return;
                
                // Show loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Verifying...';
                
                try {
                    // Send verification request
                    const response = await fetch('/api/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, code })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Verification successful, show documents
                        showDocumentsSection();
                        loadDocuments();
                    } else {
                        // Show error message
                        showLoginError(emailInput, codeInput, data.error || 'Verification failed');
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    showLoginError(emailInput, codeInput, 'Network error. Please try again.');
                } finally {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            });
        }
        
        // Show email validation error
        function showEmailError(input, errorElement, message = '') {
            if (!message) {
                if (input.validity.valueMissing) {
                    message = 'Email is required';
                } else if (input.validity.typeMismatch) {
                    message = 'Please enter a valid email address';
                } else if (input.validity.tooShort) {
                    message = `Email should be at least ${input.minLength} characters`;
                }
            }
            errorElement.textContent = message;
            input.classList.add('invalid');
        }
        
        // Show code validation error
        function showCodeError(input, errorElement, message = '') {
            if (!message) {
                if (input.validity.valueMissing) {
                    message = 'Access code is required';
                } else if (input.validity.patternMismatch) {
                    message = 'Code must be 6 digits';
                }
            }
            errorElement.textContent = message;
            input.classList.add('invalid');
        }
        
        // Show login error
        function showLoginError(emailInput, codeInput, message) {
            // Clear previous errors
            document.getElementById('emailError').textContent = '';
            document.getElementById('codeError').textContent = '';
            
            // Show error message in a toast or alert
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-toast';
            errorDiv.textContent = message;
            
            // Style the error toast
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.backgroundColor = '#ff6b6b';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '10px 20px';
            errorDiv.style.borderRadius = '4px';
            errorDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            errorDiv.style.zIndex = '1000';
            
            document.body.appendChild(errorDiv);
            
            // Remove error after 5 seconds
            setTimeout(() => {
                errorDiv.style.opacity = '0';
                errorDiv.style.transition = 'opacity 0.5s';
                setTimeout(() => errorDiv.remove(), 500);
            }, 5000);
            
            // Focus on the first invalid input
            if (emailInput.validity.valid) {
                codeInput.focus();
            } else {
                emailInput.focus();
            }
        }
        
        // Show login section and hide documents
        function showLoginSection() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('documents-section').style.display = 'none';
        }
        
        // Show documents section and hide login
        function showDocumentsSection() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('documents-section').style.display = 'block';
        }
        
        // Load and display documents
        async function loadDocuments() {
            const container = document.getElementById('documentsList');
            const emptyState = document.getElementById('emptyState');
            
            // Show loading state
            container.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Loading documents...</td></tr>';
            emptyState.style.display = 'none';
            
            try {
                const response = await fetch('/api/documents');
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Session expired, show login form
                        showLoginSection();
                        return;
                    }
                    throw new Error('Failed to load documents');
                }
                
                const documents = await response.json();
                
                if (documents.length === 0) {
                    emptyState.style.display = 'block';
                    container.innerHTML = '';
                } else {
                    displayDocuments(documents);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                container.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #ff6b6b; padding: 20px;">Error loading documents. Please try again later.</td></tr>';
            }
        }
        
        // Handle sign out
        async function handleSignOut() {
            try {
                const response = await fetch('/api/signout', { method: 'POST' });
                if (response.ok) {
                    showLoginSection();
                    // Reset form
                    document.getElementById('loginForm').reset();
                } else {
                    throw new Error('Failed to sign out');
                }
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out. Please try again.');
            }
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Format date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Get file icon based on file extension
        function getFileIcon(type) {
            const icons = {
                'docx': 'üìÑ',
                'doc': 'üìÑ',
                'pdf': 'üìë',
                'xlsx': 'üìä',
                'xls': 'üìä',
                'pptx': 'üìù',
                'ppt': 'üìù',
                'txt': 'üìù',
                'zip': 'üóúÔ∏è',
                'rar': 'üóúÔ∏è',
                '7z': 'üóúÔ∏è'
            };
            return icons[type] || 'üìÑ';
        }
        
        // Display documents in the table
        function displayDocuments(documents) {
            const container = document.getElementById('documentsList');
            container.innerHTML = '';
            
            if (documents.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            documents.forEach(doc => {
                const row = document.createElement('tr');
                const fileExt = doc.name.split('.').pop().toLowerCase();
                const fileIcon = getFileIcon(fileExt);
                
                row.innerHTML = `
                    <td>
                        <a href="${doc.path}" class="document-link" target="_blank" download>
                            <span class="document-icon">${fileIcon}</span>
                            ${doc.name}
                        </a>
                    </td>
                    <td>${formatFileSize(doc.size)}</td>
                    <td>${formatDate(doc.lastModified)}</td>
                `;
                container.appendChild(row);
            });
        }
    </script>
</body>
</html>
